- block:
  - name: create deploy dir
    file:
      state: directory
      path: "{{ iroha_deploy_dir }}/conf"

  # Attachable overlay network cannot be created with a `docker_network` module
  - name: create Docker network
    shell: "docker network create -d overlay --attachable {{ iroha_network_name }} --gateway {{ iroha_network_gateway }} --subnet {{ iroha_network_address }} || true"
    when: iroha_overlay_network and (ansible_play_batch | length > 1)
    run_once: yes

  - name: create Docker network
    docker_network:
      name: "{{ iroha_network_name }}"
    when: not iroha_overlay_network or (ansible_play_batch | length == 1)

  - name: generate Docker Compose
    template:
      src: docker-compose.yml.j2
      dest: "{{ iroha_deploy_dir }}/docker-compose.yml"
    notify: restart Iroha
    tags: ["iroha-deploy"]

  - name: generate config files
    template:
      src: config.docker.j2
      dest: "{{ iroha_deploy_dir }}/conf/{{ item.human_hostname }}/config.docker"
    notify: restart Iroha
    loop: "{{ iroha_nodes }}"
    tags: ["iroha-deploy"]

  - name: run Iroha
    docker_service:
      project_src: "{{ iroha_deploy_dir }}"
    tags: ["iroha-deploy"]

  - name: Add node
    docker_container:
      name: "iroha_command"
      image: "python:stretch"
      recreate: yes
      detach: no
      cleanup: yes
      networks:
        - name: "{{iroha_network_name}}"
      entrypoint: "bash -c"
      volumes:
        - "{{ iroha_deploy_dir }}/iroha_utils.py:/iroha_utils.py:ro"
      command:
        - "'pip3 install iroha &>/dev/null && python3 /iroha_utils.py add_peer {{ item.hostname }} {{ item.pub_key }}'"
      env:
        IROHA_HOSTS: "{% for iroha_node in iroha_old_nodes %}{{ iroha_node.human_hostname }}:{{ iroha_torii_port }}{% if not loop.last %},{% endif %}{% endfor %}"
        IROHA_ACCOUNT: "{{ iroha_service_account }}"
        IROHA_ACCOUNT_KEYS: "{{ iroha_service_account_keys | join(',') }}"
    when: node_change
    loop: "{{ iroha_all_new_nodes }}"
    register: iroha_command_register
    delegate_to: "{{ iroha_command_host }}"
    run_once: yes
  tags: ["iroha-docker"]
